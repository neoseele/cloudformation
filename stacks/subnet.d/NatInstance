{
    "Metadata":{
        "AWS::CloudFormation::Authentication":{
            "S3AccessCreds":{
                "roleName":{
                    "Ref":"DefaultRole"
                },
                "type":"S3"
            }
        },
        "AWS::CloudFormation::Init":{
            "config":{
                "files":{
                    "/etc/yum.repos.d/epel.repo":{
                        "group":"root",
                        "mode":"000644",
                        "owner":"root",
                        "source":"https://s3.amazonaws.com/cloudformation-examples/enable-epel-on-amazon-linux-ami"
                    },
                    "/home/ec2-user/.boto":{
                        "content":{
                            "Fn::Join":[
                                "",
                                [
                                    "[Boto]\n",
                                    "aws_region=",
                                    {
                                        "Ref":"AWS::Region"
                                    },
                                    "\n"
                                ]
                            ]
                        },
                        "group":"ec2-user",
                        "mode":"000644",
                        "owner":"ec2-user"
                    },
                    "/home/ec2-user/.gitconfig":{
                        "authentication":"S3AccessCreds",
                        "group":"ec2-user",
                        "mode":"000644",
                        "owner":"ec2-user",
                        "source":{
                            "Fn::Join":[
                                "",
                                [
                                    "https://s3-",
                                    {
                                        "Ref":"AWS::Region"
                                    },
                                    ".amazonaws.com/",
                                    {
                                        "Ref":"SystemOperationsBucketName"
                                    },
                                    "/gitconfig"
                                ]
                            ]
                        }
                    },
                    "/home/ec2-user/.vimrc":{
                        "authentication":"S3AccessCreds",
                        "group":"ec2-user",
                        "mode":"000644",
                        "owner":"ec2-user",
                        "source":{
                            "Fn::Join":[
                                "",
                                [
                                    "https://s3-",
                                    {
                                        "Ref":"AWS::Region"
                                    },
                                    ".amazonaws.com/",
                                    {
                                        "Ref":"SystemOperationsBucketName"
                                    },
                                    "/vimrc"
                                ]
                            ]
                        }
                    }
                },
                "packages":{
                    "rubygems":{
                        "json":[]
                    },
                    "yum":{
                        "gcc":[],
                        "git":[],
                        "make":[],
                        "puppet":[],
                        "ruby-devel":[],
                        "rubygems":[],
                        "tree":[]
                    }
                },
                "services":{
                    "sysvinit":{
                        "puppet":{
                            "enabled":"false",
                            "ensureRunning":"false"
                        }
                    }
                }
            }
        }
    },
    "Properties":{
        "IamInstanceProfile":{
            "Ref":"DefaultProfile"
        },
        "ImageId":{
            "Fn::FindInMap":[
                "NatRegionMap",
                {
                    "Ref":"AWS::Region"
                },
                "AMI"
            ]
        },
        "InstanceType":"t2.micro",
        "KeyName":{
            "Ref":"KeyName"
        },
        "NetworkInterfaces":[
            {
                "AssociatePublicIpAddress":"true",
                "DeleteOnTermination":"true",
                "DeviceIndex":"0",
                "GroupSet":[
                    {
                        "Ref":"NatSecurityGroup"
                    }
                ],
                "SubnetId":{
                    "Ref":"ExternalSubnet"
                }
            }
        ],
        "SourceDestCheck":"false",
        "Tags":[
            {
                "Key":"Name",
                "Value":{
                    "Fn::Join":[
                        "",
                        [
                            "NatInstance",
                            {
                                "Ref":"AvailabilityZone"
                            }
                        ]
                    ]
                }
            },
            {
                "Key":"ServiceComponent",
                "Value":"Network"
            },
            {
                "Key":"ServiceName",
                "Value":"NatInstance"
            },
            {
                "Key":"ServicePhase",
                "Value":{
                    "Ref":"ServicePhase"
                }
            }
        ],
        "UserData":{
            "Fn::Base64":{
                "Fn::Join":[
                    "",
                    [
                        "#!/bin/bash\n",
                        "exec > /root/install_log 2>&1\n",
                        "set -x\n",
                        "yum update -y && yum install -y yum-cron && chkconfig yum-cron on\n",
                        "yum update -y aws-cfn-bootstrap\n",
                        "# Install the files and packages from the metadata\n",
                        "/opt/aws/bin/cfn-init -v ",
                        "         --stack ",
                        {
                            "Ref":"AWS::StackName"
                        },
                        "         --resource NatInstance ",
                        "         --region ",
                        {
                            "Ref":"AWS::Region"
                        },
                        "\n",
                        "# Do the rest of the provisioning\n",
                        "rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-6\n",
                        "yum install -y ansible\n",
                        "cd /home/ec2-user\n",
                        "git clone https://github.com/neoseele/aws-ansible.git\n",
                        "chown -R ec2-user:ec2-user aws-ansible\n"
                    ]
                ]
            }
        }
    },
    "Type":"AWS::EC2::Instance"
}