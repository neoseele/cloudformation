# MegaStack name. All stacks in CF get prefixed with this name.
---
Demo:
  Name: &Name Vpc1
  region: &Region ap-southeast-2
  Environment: &Environment Dev
  KeyName: &KeyName nmiao
  VpcCidrRange: &VpcCidrRange 10.0.0.0/16
  ExternalLoadBalancerA: &ExternalLoadBalancerA 10.0.0.0/24
  ExternalLoadBalancerB: &ExternalLoadBalancerB 10.0.128.0/24
  ExternalA: &ExternalA 10.0.1.0/24
  ExternalB: &ExternalB 10.0.129.0/24
  ApplicationA: &ApplicationA 10.0.2.0/24
  ApplicationB: &ApplicationB 10.0.130.0/24
  DatabaseA: &DatabaseA 10.0.3.0/24
  DatabaseB: &DatabaseB 10.0.131.0/24

  stacks:
    VPC:
      cf_template: vpc.json
      depends:
      params:
        CIDR:
          value: *VpcCidrRange
        Environment:
          value: *Environment
    Shared:
      cf_template: shared.json
      depends:
        - VPC
      params:
        VPC:
          source: VPC
          type: resource
          variable: VPC
    SubnetAzA:
      cf_template: subnet.json
      depends:
        - Shared
      params:
        AvailabilityZone:
          value: A
        VPC:
          source: VPC
          type: resource
          variable: VPC
        ExternalRouteTable:
          source: Shared
          type: resource
          variable: ExternalRouteTable
        InternalRouteTable:
          source: Shared
          type: resource
          variable: InternalRouteTable
        ExternalAcl:
          source: Shared
          type: resource
          variable: ExternalAcl
        InternalAcl:
          source: Shared
          type: resource
          variable: InternalAcl
        ExternalCIDR:
          value: *ExternalA
        ExternalLoadBalancerCIDR:
          value: *ExternalLoadBalancerA
        ApplicationCIDR:
          value: *ApplicationA
        DatabaseCIDR:
          value: *DatabaseA
        Region:
          value: *Region
        Environment:
          value: *Environment
    SubnetAzB:
      cf_template: subnet.json
      depends:
        - Shared
      params:
        AvailabilityZone:
          value: B
        VPC:
          source: VPC
          type: resource
          variable: VPC
        ExternalRouteTable:
          source: Shared
          type: resource
          variable: ExternalRouteTable
        InternalRouteTable:
          source: Shared
          type: resource
          variable: InternalRouteTable
        ExternalAcl:
          source: Shared
          type: resource
          variable: ExternalAcl
        InternalAcl:
          source: Shared
          type: resource
          variable: InternalAcl
        ExternalCIDR:
          value: *ExternalB
        ExternalLoadBalancerCIDR:
          value: *ExternalLoadBalancerB
        ApplicationCIDR:
          value: *ApplicationB
        DatabaseCIDR:
          value: *DatabaseB
        Region:
          value: *Region
        Environment:
          value: *Environment
    NatA:
      cf_template: nat.json
      depends:
        - SubnetAzA
      params:
        AvailabilityZone:
          value: A
        VPC:
          source: VPC
          type: resource
          variable: VPC
        ExternalSubnet:
          source: SubnetAzA
          type: resource
          variable: ExternalSubnet
        InternalSharedTable:
          source: Shared
          type: resource
          variable: InternalSharedTable
        KeyName:
          value: *KeyName
    LAMP:
      cf_template: lamp.json
      depends:
        - SubnetAzA
        - SubnetAzB
      params:
        VPC:
          source: VPC
          type: resource
          variable: VPC
        LoadBalancerSubnets:
          - source: SubnetAzA
            type: resource
            variable: ExternalLoadBalancerSubnet
          - source: SubnetAzB
            type: resource
            variable: ExternalLoadBalancerSubnet
        DatabaseSubnets:
          - source: SubnetAzA
            type: resource
            variable: DatabaseSubnet
          - source: SubnetAzB
            type: resource
            variable: DatabaseSubnet
        VPCZoneIdentifier:
          - source: SubnetAzA
            type: resource
            variable: ApplicationSubnet
          - source: SubnetAzB
            type: resource
            variable: ApplicationSubnet
        NatSecurityGroup:
          source: NatA
          type: resource
          variable: NatSecurityGroup
        KeyName:
          value: *KeyName
        DBName:
          value: drupal
        DBUser:
          value: drupal
        DBPassword:
          value: drupal123
        MultiAZDatabase:
          value: "false"

