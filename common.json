{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "VPC Common",
    "Parameters": {
        "Cidr": {
            "Description": "VPC IP range",
            "Type": "String"
        },
        "ServerAccess": {
            "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
            "ConstraintDescription": "must be a valid CIDR range of the form x.x.x.x/x.",
            "Default": "0.0.0.0/0",
            "Description": "CIDR IP range allowed to login to the NAT instance",
            "MaxLength": "18",
            "MinLength": "9",
            "Type": "String"
        },
        "ServicePhase": {
            "Description": "",
            "Type": "String"
        },
        "VpcName": {
            "Description": "VPC Name",
            "Type": "String"
        }
    },
    "Resources": {
        "ExternalAcl": {
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "ExternalAcl"
                    },
                    {
                        "Key": "ServiceComponent",
                        "Value": "Network"
                    },
                    {
                        "Key": "ServiceName",
                        "Value": "ExternalAcl"
                    },
                    {
                        "Key": "ServicePhase",
                        "Value": {
                            "Ref": "ServicePhase"
                        }
                    }
                ],
                "VpcId": {
                    "Ref": "Vpc"
                }
            },
            "Type": "AWS::EC2::NetworkAcl"
        },
        "ExternalAclEg100": {
            "Properties": {
                "CidrBlock": "0.0.0.0/0",
                "Egress": "True",
                "NetworkAclId": {
                    "Ref": "ExternalAcl"
                },
                "PortRange": {
                    "From": "0",
                    "To": "65535"
                },
                "Protocol": "-1",
                "RuleAction": "Allow",
                "RuleNumber": "100"
            },
            "Type": "AWS::EC2::NetworkAclEntry"
        },
        "ExternalAclIg100": {
            "Properties": {
                "CidrBlock": "0.0.0.0/0",
                "Egress": "False",
                "NetworkAclId": {
                    "Ref": "ExternalAcl"
                },
                "PortRange": {
                    "From": "0",
                    "To": "65535"
                },
                "Protocol": "-1",
                "RuleAction": "Allow",
                "RuleNumber": "100"
            },
            "Type": "AWS::EC2::NetworkAclEntry"
        },
        "ExternalRoute": {
            "Properties": {
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "InternetGateway"
                },
                "RouteTableId": {
                    "Ref": "ExternalRouteTable"
                }
            },
            "Type": "AWS::EC2::Route"
        },
        "ExternalRouteTable": {
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "ExternalRouteTable"
                    },
                    {
                        "Key": "ServiceComponent",
                        "Value": "Network"
                    },
                    {
                        "Key": "ServiceName",
                        "Value": "ExternalRouteTable"
                    },
                    {
                        "Key": "ServicePhase",
                        "Value": {
                            "Ref": "ServicePhase"
                        }
                    }
                ],
                "VpcId": {
                    "Ref": "Vpc"
                }
            },
            "Type": "AWS::EC2::RouteTable"
        },
        "GatewayToInternet": {
            "Properties": {
                "InternetGatewayId": {
                    "Ref": "InternetGateway"
                },
                "VpcId": {
                    "Ref": "Vpc"
                }
            },
            "Type": "AWS::EC2::VPCGatewayAttachment"
        },
        "InternalAcl": {
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "InternalAcl"
                    },
                    {
                        "Key": "ServiceComponent",
                        "Value": "Network"
                    },
                    {
                        "Key": "ServiceName",
                        "Value": "InternalAcl"
                    },
                    {
                        "Key": "ServicePhase",
                        "Value": {
                            "Ref": "ServicePhase"
                        }
                    }
                ],
                "VpcId": {
                    "Ref": "Vpc"
                }
            },
            "Type": "AWS::EC2::NetworkAcl"
        },
        "InternalAclEg100": {
            "Properties": {
                "CidrBlock": "0.0.0.0/0",
                "Egress": "True",
                "NetworkAclId": {
                    "Ref": "InternalAcl"
                },
                "PortRange": {
                    "From": "0",
                    "To": "65535"
                },
                "Protocol": "-1",
                "RuleAction": "Allow",
                "RuleNumber": "100"
            },
            "Type": "AWS::EC2::NetworkAclEntry"
        },
        "InternalAclIg100": {
            "Properties": {
                "CidrBlock": "0.0.0.0/0",
                "Egress": "False",
                "NetworkAclId": {
                    "Ref": "InternalAcl"
                },
                "PortRange": {
                    "From": "0",
                    "To": "65535"
                },
                "Protocol": "-1",
                "RuleAction": "Allow",
                "RuleNumber": "100"
            },
            "Type": "AWS::EC2::NetworkAclEntry"
        },
        "InternalRouteTable": {
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "InternalRouteTable"
                    },
                    {
                        "Key": "ServiceComponent",
                        "Value": "Network"
                    },
                    {
                        "Key": "ServiceName",
                        "Value": "InternalRouteTable"
                    },
                    {
                        "Key": "ServicePhase",
                        "Value": {
                            "Ref": "ServicePhase"
                        }
                    }
                ],
                "VpcId": {
                    "Ref": "Vpc"
                }
            },
            "Type": "AWS::EC2::RouteTable"
        },
        "InternetGateway": {
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "InternetGateway"
                    },
                    {
                        "Key": "ServiceComponent",
                        "Value": "Network"
                    },
                    {
                        "Key": "ServiceName",
                        "Value": "InternetGateway"
                    },
                    {
                        "Key": "ServicePhase",
                        "Value": {
                            "Ref": "ServicePhase"
                        }
                    }
                ]
            },
            "Type": "AWS::EC2::InternetGateway"
        },
        "NatSecurityGroup": {
            "Properties": {
                "GroupDescription": "NAT Security Group",
                "SecurityGroupIngress": [
                    {
                        "CidrIp": {
                            "Ref": "ServerAccess"
                        },
                        "FromPort": "22",
                        "IpProtocol": "tcp",
                        "ToPort": "22"
                    },
                    {
                        "CidrIp": {
                            "Ref": "ServerAccess"
                        },
                        "FromPort": "3389",
                        "IpProtocol": "tcp",
                        "ToPort": "3389"
                    }
                ],
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "NatSecurityGroup"
                    },
                    {
                        "Key": "ServiceComponent",
                        "Value": "Network"
                    },
                    {
                        "Key": "ServiceName",
                        "Value": "NatSecurityGroup"
                    },
                    {
                        "Key": "ServicePhase",
                        "Value": {
                            "Ref": "ServicePhase"
                        }
                    }
                ],
                "VpcId": {
                    "Ref": "Vpc"
                }
            },
            "Type": "AWS::EC2::SecurityGroup"
        },
        "NatSecurityGroupIngress1": {
            "DependsOn": [
                "NatSecurityGroup"
            ],
            "Properties": {
                "FromPort": "-1",
                "GroupId": {
                    "Ref": "NatSecurityGroup"
                },
                "IpProtocol": "icmp",
                "SourceSecurityGroupId": {
                    "Ref": "NatSecurityGroup"
                },
                "ToPort": "-1"
            },
            "Type": "AWS::EC2::SecurityGroupIngress"
        },
        "NatSecurityGroupIngress22": {
            "DependsOn": [
                "NatSecurityGroup"
            ],
            "Properties": {
                "FromPort": "22",
                "GroupId": {
                    "Ref": "NatSecurityGroup"
                },
                "IpProtocol": "tcp",
                "SourceSecurityGroupId": {
                    "Ref": "NatSecurityGroup"
                },
                "ToPort": "22"
            },
            "Type": "AWS::EC2::SecurityGroupIngress"
        },
        "NatSecurityGroupIngress3389": {
            "DependsOn": [
                "NatSecurityGroup"
            ],
            "Properties": {
                "FromPort": "3389",
                "GroupId": {
                    "Ref": "NatSecurityGroup"
                },
                "IpProtocol": "tcp",
                "SourceSecurityGroupId": {
                    "Ref": "NatSecurityGroup"
                },
                "ToPort": "3389"
            },
            "Type": "AWS::EC2::SecurityGroupIngress"
        },
        "NatSecurityGroupIngress443": {
            "DependsOn": [
                "NatSecurityGroup"
            ],
            "Properties": {
                "FromPort": "443",
                "GroupId": {
                    "Ref": "NatSecurityGroup"
                },
                "IpProtocol": "tcp",
                "SourceSecurityGroupId": {
                    "Ref": "NatSecurityGroup"
                },
                "ToPort": "443"
            },
            "Type": "AWS::EC2::SecurityGroupIngress"
        },
        "NatSecurityGroupIngress80": {
            "DependsOn": [
                "NatSecurityGroup"
            ],
            "Properties": {
                "FromPort": "80",
                "GroupId": {
                    "Ref": "NatSecurityGroup"
                },
                "IpProtocol": "tcp",
                "SourceSecurityGroupId": {
                    "Ref": "NatSecurityGroup"
                },
                "ToPort": "80"
            },
            "Type": "AWS::EC2::SecurityGroupIngress"
        },
        "Vpc": {
            "Properties": {
                "CidrBlock": {
                    "Ref": "Cidr"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": {
                            "Ref": "VpcName"
                        }
                    },
                    {
                        "Key": "ServiceComponent",
                        "Value": "Network"
                    },
                    {
                        "Key": "ServiceName",
                        "Value": "Vpc"
                    },
                    {
                        "Key": "ServicePhase",
                        "Value": {
                            "Ref": "ServicePhase"
                        }
                    }
                ]
            },
            "Type": "AWS::EC2::VPC"
        }
    }
}
